<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --c1:#0b2d5c;
  --c2:#1565c0;
  --chip:rgba(255,255,255,.15);
  --shadow:0 12px 28px rgba(0,0,0,.28);
}

body{
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  font-family:system-ui,Segoe UI,Arial;
  background:transparent;
}

.card{
  width:260px;
  height:260px;
  border-radius:22px;
  background:linear-gradient(160deg,var(--c1),var(--c2));
  color:white;
  padding:14px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  box-shadow:var(--shadow);
  transition: background 650ms ease, box-shadow 650ms ease;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.station{
  font-weight:750;
  font-size:15px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.logo{
  width:30px;
  height:30px;
  object-fit:contain;
  background:white;
  border-radius:6px;
  padding:2px;
  flex:0 0 auto;
}

.temp{
  font-size:52px;
  font-weight:850;
  text-align:center;
  letter-spacing:-1px;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}

.box{
  background:var(--chip);
  border-radius:12px;
  padding:7px 6px;
  text-align:center;
  backdrop-filter: blur(6px);
}

.value{ font-weight:800; }

.label{
  font-size:11px;
  opacity:.82;
  margin-top:2px;
}

.footer{
  font-size:11px;
  text-align:center;
  opacity:.86;
  display:flex;
  justify-content:center;
  gap:8px;
  align-items:center;
}

.dot{
  width:7px;
  height:7px;
  border-radius:999px;
  background:rgba(255,255,255,.72);
}
</style>
</head>

<body>

<div class="card" id="card">
  <div class="header">
    <div class="station" id="title">‚è≥ El Masnou NE</div>
    <img class="logo"
      src="https://francescmontana-dev.github.io/fmp14352/LOGO%20A%20TAMA%C3%91O%20WEB.png"
      alt="Logo estaci√≥">
  </div>

  <div class="temp">
    <span id="temp">--</span>¬∞C
  </div>

  <div class="grid">
    <div class="box">
      <div class="value" id="hum">--</div>
      <div class="label">Humitat</div>
    </div>

    <div class="box">
      <div class="value" id="wind">--</div>
      <div class="label">Vent</div>
    </div>

    <div class="box">
      <div class="value" id="rain">--</div>
      <div class="label">Pluja avui</div>
    </div>

    <div class="box">
      <div class="value" id="press">--</div>
      <div class="label">Pressi√≥</div>
    </div>
  </div>

  <div class="footer">
    <span class="dot"></span>
    <span>Actualitzat</span>
    <span id="time">--:--</span>
  </div>
</div>

<script>
(() => {
  const realtimeURL = "https://francescmontana-dev.github.io/fmp14352/realtime.txt";

  // Coordenades El Masnou (aprox.)
  const LAT = 41.4798;
  const LON = 2.3188;

  const el = (id) => document.getElementById(id);
  const num = (s) => {
    const x = parseFloat(String(s).replace(",", "."));
    return Number.isFinite(x) ? x : null;
  };

  // C√†lcul sortida/posta (estil NOAA). Retorna dates UTC que comparen b√© amb Date() local.
  function sunTimes(date, lat, lon) {
    const rad = Math.PI / 180;
    const day = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const start = new Date(day.getFullYear(), 0, 0);
    const doy = Math.floor((day - start) / 86400000);
    const lngHour = lon / 15;

    function calc(isSunrise) {
      const t = doy + ((isSunrise ? 6 : 18) - lngHour) / 24;
      const M = (0.9856 * t) - 3.289;

      let L = M + (1.916 * Math.sin(M * rad)) + (0.020 * Math.sin(2 * M * rad)) + 282.634;
      L = (L + 360) % 360;

      let RA = Math.atan(0.91764 * Math.tan(L * rad)) / rad;
      RA = (RA + 360) % 360;

      const Lq  = Math.floor(L / 90) * 90;
      const RAq = Math.floor(RA / 90) * 90;
      RA = (RA + (Lq - RAq)) / 15;

      const sinDec = 0.39782 * Math.sin(L * rad);
      const cosDec = Math.cos(Math.asin(sinDec));

      const zenith = 90.833;
      const cosH = (Math.cos(zenith * rad) - (sinDec * Math.sin(lat * rad))) / (cosDec * Math.cos(lat * rad));
      if (cosH > 1 || cosH < -1) return null;

      let H = isSunrise ? (360 - (Math.acos(cosH) / rad)) : (Math.acos(cosH) / rad);
      H = H / 15;

      const T = H + RA - (0.06571 * t) - 6.622;

      let UT = (T - lngHour) % 24;
      if (UT < 0) UT += 24;

      const utc = new Date(Date.UTC(day.getFullYear(), day.getMonth(), day.getDate(), 0, 0, 0));
      utc.setUTCHours(Math.floor(UT), Math.floor((UT % 1) * 60), 0, 0);
      return utc;
    }

    return { sunrise: calc(true), sunset: calc(false) };
  }

  function isDayNow(now) {
    const st = sunTimes(now, LAT, LON);
    if (!st.sunrise || !st.sunset) {
      const h = now.getHours();
      return h >= 7 && h < 20;
    }
    return now >= st.sunrise && now < st.sunset;
  }

  function setTheme(day) {
    if (day) {
      document.documentElement.style.setProperty("--c1", "#0b2d5c");
      document.documentElement.style.setProperty("--c2", "#1565c0");
      document.documentElement.style.setProperty("--chip", "rgba(255,255,255,.15)");
      document.documentElement.style.setProperty("--shadow", "0 12px 28px rgba(0,0,0,.28)");
    } else {
      document.documentElement.style.setProperty("--c1", "#050716");
      document.documentElement.style.setProperty("--c2", "#2b2a6f");
      document.documentElement.style.setProperty("--chip", "rgba(255,255,255,.10)");
      document.documentElement.style.setProperty("--shadow", "0 14px 34px rgba(0,0,0,.38)");
    }
  }

  // Icona segons condicions (simple i efectiva)
  function pickIcon({ day, rainRate, hum, wind, gust }) {
    if (rainRate != null && rainRate > 0) return "üåßÔ∏è";
    if (hum != null && hum >= 95 && (wind != null && wind <= 5)) return "üå´Ô∏è";
    if (gust != null && gust >= 35) return "üí®";
    return day ? "‚òÄÔ∏è" : "üåô";
  }

  async function load() {
    const r = await fetch(realtimeURL + "?t=" + Date.now(), { cache: "no-store" });
    const text = (await r.text()).trim();
    const d = text.split(/\s+/);

    // 0 date, 1 time, 2 temp, 3 hum, 4 dew, 5 wind, 6 gust, 7 bearing, 8 rainRate, 9 rainToday, 10 pressure, 11 winddir
    const timeStr = d[1] ? d[1].substring(0,5) : "--:--";
    const temp = d[2] ?? "--";
    const hum  = d[3] ?? "--";
    const wind = d[5] ?? "--";
    const gust = d[6] ?? "--";
    const rainRate = num(d[8]);
    const rainToday = d[9] ?? "--";
    const press = d[10] ?? "--";
    const wdir = d[11] ? ` ${d[11]}` : "";

    el("temp").textContent = temp;
    el("hum").textContent  = hum + " %";
    el("wind").textContent = `${wind} km/h (ratxa ${gust})${wdir}`;
    el("rain").textContent = rainToday + " mm";
    el("press").textContent= press + " hPa";
    el("time").textContent = timeStr;

    const now = new Date();
    const day = isDayNow(now);
    setTheme(day);

    const icon = pickIcon({
      day,
      rainRate,
      hum: num(hum),
      wind: num(wind),
      gust: num(gust)
    });

    el("title").textContent = `${icon} El Masnou NE`;
  }

  load().catch(()=>{});
  setInterval(() => load().catch(()=>{}), 30000);
})();
</script>

</body>
</html>
