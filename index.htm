<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estació Meteorològica El Masnou-NE</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #fff; color: #111; }
    header { padding: 18px 16px; border-bottom: 1px solid #ddd; }
    header h1 { margin: 0; font-size: 20px; }
    header .sub { margin-top: 6px; color: #444; font-size: 13px; }

    main { padding: 16px; max-width: 1100px; margin: 0 auto; }

    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-bottom: 16px; }
    .card h2 { margin: 0 0 10px 0; font-size: 16px; }
    .muted { color: #555; font-size: 13px; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; border-bottom: 1px solid #ddd; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }

    .ok { color: #0a6; }
    .err { color: #b00; }
    code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
    footer { padding: 16px; border-top: 1px solid #ddd; color: #555; font-size: 12px; }
  </style>
</head>

<body>
  <header>
    <h1>Estació Meteorològica El Masnou-NE</h1>
    <div class="sub">
      Web pública (GitHub Pages) · Previsió model: OpenWeather · Tendència local: Cumulus/Zambretti
    </div>
  </header>

  <main>
    <!-- 1) BLOQUE OPENWEATHER -->
    <section class="card" id="owm">
      <h2>Previsió model (OpenWeather)</h2>
      <div id="owm-meta" class="muted">Carregant previsió…</div>

      <div class="grid" style="margin-top:12px;">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:14px;">Diària (5 dies)</h3>
          <div id="owm-daily"></div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0; font-size:14px;">Horària (24 h)</h3>
          <div id="owm-hourly"></div>
        </div>
      </div>
    </section>

    <!-- 2) AQUÍ PUEDES PEGAR TU CONTENIDO ACTUAL DE CUMULUS / TU WEB -->
    <section class="card">
      <h2>Dades de l’estació</h2>
      <div class="muted">
        Aquí pots enganxar el contingut del teu <code>index.htm</code> antic (taules, gràfics, etc.).
        Si vols, en el següent pas també llegim <code>websitedata.json</code> i mostrem Zambretti en català.
      </div>
    </section>
  </main>

  <footer>
    © Estació Meteorològica El Masnou-NE · Actualització automàtica de previsió via GitHub Actions
  </footer>

  <script>
    // Lee los ficheros generados en la rama owm-data
    const OWM_JSON_URL = "https://raw.githubusercontent.com/francescmontana-dev/fmp14352/owm-data/owm_forecast.json";
    const OWM_UPD_URL  = "https://raw.githubusercontent.com/francescmontana-dev/fmp14352/owm-data/owm_forecast_updated_utc.txt";

    function fmtDay(dt) {
      return dt.toLocaleDateString("ca-ES", { weekday: "short", day: "2-digit", month: "2-digit" });
    }
    function fmtTime(dt) {
      return dt.toLocaleTimeString("ca-ES", { hour: "2-digit", minute: "2-digit" });
    }

    async function loadOWM() {
      const meta = document.getElementById("owm-meta");
      const dailyEl = document.getElementById("owm-daily");
      const hourlyEl = document.getElementById("owm-hourly");

      try {
        const [rF, rU] = await Promise.all([
          fetch(OWM_JSON_URL, { cache: "no-store" }),
          fetch(OWM_UPD_URL, { cache: "no-store" })
        ]);

        if (!rF.ok) throw new Error("No puc llegir owm_forecast.json");
        const data = await rF.json();

        const updated = rU.ok ? (await rU.text()).trim() : "";
        meta.innerHTML = updated
          ? `<span class="ok">OK</span> · Actualitzat (UTC): <b>${updated}</b>`
          : `<span class="ok">OK</span> · Actualitzat recentment`;

        // Horària: pròximes 8 franges (≈24 h)
        const nextRows = data.list.slice(0, 8).map(p => {
          const dt = new Date(p.dt * 1000);
          const t = Math.round(p.main.temp);
          const pop = Math.round((p.pop ?? 0) * 100);
          const w = Math.round((p.wind?.speed ?? 0) * 3.6); // m/s -> km/h
          const desc = p.weather?.[0]?.description ?? "";
          return `<tr>
            <td>${fmtTime(dt)}</td>
            <td>${t}°C</td>
            <td>${pop}%</td>
            <td>${w} km/h</td>
            <td>${desc}</td>
          </tr>`;
        }).join("");

        hourlyEl.innerHTML = `
          <table>
            <thead>
              <tr><th>Hora</th><th>Temp</th><th>Prob. pluja</th><th>Vent</th><th>Estat</th></tr>
            </thead>
            <tbody>${nextRows}</tbody>
          </table>
        `;

        // Diària: agrupar per dia
        const byDay = new Map();
        for (const p of data.list) {
          const key = new Date(p.dt * 1000).toISOString().slice(0,10);
          const tmin = p.main.temp_min;
          const tmax = p.main.temp_max;
          const pop = (p.pop ?? 0);
          const wind = (p.wind?.speed ?? 0);
          const desc = p.weather?.[0]?.description ?? "";
          if (!byDay.has(key)) byDay.set(key, { tmin, tmax, popMax: pop, windMax: wind, desc });
          const o = byDay.get(key);
          o.tmin = Math.min(o.tmin, tmin);
          o.tmax = Math.max(o.tmax, tmax);
          o.popMax = Math.max(o.popMax, pop);
          o.windMax = Math.max(o.windMax, wind);
        }

        const dayRows = Array.from(byDay.entries()).slice(0, 5).map(([key, o]) => {
          const dt = new Date(key + "T12:00:00");
          const tmin = Math.round(o.tmin);
          const tmax = Math.round(o.tmax);
          const pop = Math.round(o.popMax * 100);
          const w = Math.round(o.windMax * 3.6);
          const desc = o.desc || "";
          return `<tr>
            <td>${fmtDay(dt)}</td>
            <td>${tmin}° / ${tmax}°</td>
            <td>${pop}%</td>
            <td>${w} km/h</td>
            <td>${desc}</td>
          </tr>`;
        }).join("");

        dailyEl.innerHTML = `
          <table>
            <thead>
              <tr><th>Dia</th><th>Tmin / Tmax</th><th>Prob. pluja</th><th>Vent (max)</th><th>Estat</th></tr>
            </thead>
            <tbody>${dayRows}</tbody>
          </table>
        `;

      } catch (e) {
        meta.innerHTML = `<span class="err">ERROR</span> · No s’ha pogut carregar OpenWeather.`;
        dailyEl.innerHTML = "";
        hourlyEl.innerHTML = "";
        console.error(e);
      }
    }

    loadOWM();
  </script>
</body>
</html>
